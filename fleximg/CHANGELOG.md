# Changelog

このプロジェクトの主要な変更を記録します。

---

## 2026-01-07

### fleximg への名称変更とArduino互換構造へのリファクタリング

**プロジェクト構造の変更**
- `image-transform-preview` → `fleximg` に名称変更
- コアライブラリを `src/fleximg/` に配置（Arduino互換構造）
- Webデモを `demo/web/` に分離
- バインディングコードを `demo/bindings.cpp` に移動

**名前空間の統一**
- `namespace ImageTransform` → `namespace FLEXIMG_NAMESPACE` に変更
- マクロによるカスタマイズ対応（デフォルト: `fleximg`）

**ビルドシステムの更新**
- `build.sh`: 新しいパス構造に対応、`-I src` フラグ追加
- `Makefile`: src/fleximg/ パスに更新
- `.github/workflows/deploy.yml`: fleximg/demo/web/ からデプロイ

**ドキュメント更新**
- README.md: タイトル、構造説明、パスを更新
- CLAUDE.md, CLAUDE.local.md: ビルドパスを更新
- docs/: QUICKSTART.md, PROJECT_STATUS.md, GITHUB_PAGES_SETUP.md を更新

---

### ネイティブテスト環境の構築

**テストフレームワーク導入**
- Google Test (gtest 1.17.0) を Homebrew 経由で導入
- `make test` でテストランナーを実行可能に
- パラメータ化テスト対応

**ViewPort 単体テスト (21テスト)**
- 構築・メモリレイアウト・ピクセルアクセス
- コピー/ムーブセマンティクス
- SubView 作成・アクセス
- フォーマット変換 (RGBA8 ↔ RGBA16)
- Image との相互変換
- srcOrigin の保持

**AffineOperator テスト (39テスト)**
- 12パターンの出力範囲検証（3原点 × 4角度）
- ピクセルマッピングの正確性検証
- ±1度安定性テスト
- 単位行列・平行移動の基本テスト

**CLIツール**
- `build/imgproc` - コマンドライン画像処理ツール
- オプション: `--brightness`, `--grayscale`, `--alpha`
- stb_image/stb_image_write による画像I/O

### AffineOperator テスト修正

**設計仕様の明確化**
- `originX/Y` パラメータは「回転中心点」として実装されている
- 単位行列（0度回転）の場合、origin は効果を持たない（数学的に正しい動作）
- テスト期待値を回転中心設計に基づき再計算

**修正内容**
- 12パターンの期待値を回転中心設計に合わせて修正
- `verifyPixelMapping` 関数の計算式を修正
- テストコメントに回転中心設計の数式を明記

### 既知の問題

**Premultiply 精度問題**
- `RGBA8_Straight` → `RGBA16_Premultiplied` 変換で 65535 が 65534 になる
- 原因: `(r16 * a16) >> 16` の丸め誤差
- TODO.md に将来の改善項目として記録

---

## 2026-01-06

### ピクセルフォーマット最適化

**標準フォーマットの変更**
- 標準（中間）フォーマットを `RGBA16_Straight` → `RGBA8_Straight` に変更
- `RGBA16_Straight` フォーマットを完全に廃止
- 変換時の中間バッファが 16bit → 8bit に削減（メモリ効率向上）

**API統一**
- `ImageProcessor::convertPixelFormat()` を廃止
- フォーマット変換は `ViewPort::convertTo()` に統一
- node_graph.cpp 内の7箇所の変換呼び出しを更新

**アルファフィルタの両フォーマット対応**
- 入力が `RGBA16_Premultiplied` → 16bit処理（RGBA全チャンネル乗算）
- 入力が `RGBA8_Straight` → 8bit処理（Alphaのみ乗算、変換不要）
- その他 → `RGBA8_Straight` に変換して8bit処理

---

### タイル分割出力機能（Phase 6）

**タイル分割設定UI**
- サイドバーにタイル分割戦略セレクトボックスを追加
- 4つの分割戦略を選択可能:
  - なし（一括処理）: 従来互換モード
  - スキャンライン（1行ずつ）: 極小メモリ環境向け
  - 64x64タイル: 組込み環境標準
  - カスタム: 任意サイズのタイル
- カスタムモード時は幅・高さ入力欄を表示

**WASMバインディング拡張**
- `setTileStrategy(strategy, tileWidth, tileHeight)` APIを追加
- JavaScript側からタイル分割戦略を設定可能に

**ピクセル整合性テスト**
- 「なし」モードと「64x64タイル」モード: 完全一致
- 「なし」モードと「スキャンライン」モード: 完全一致
- タイル境界での継ぎ目問題なし

---

### 2パス評価システム（タイル分割対応）

**画像切れ問題の修正**
- キャンバスサイズ < 入力画像サイズ + オフセット の場合に発生していた画像切れを修正
- `applyTransform()` / `mergeImages()` に出力サイズパラメータを追加
- アフィン変換の出力サイズを入力画像サイズに基づいて動的決定

**3段階評価アーキテクチャ**
- 段階0（prepare）: 逆行列計算、フィルタカーネル準備などの事前計算
- 段階1（propagateRequests）: タイルごとの必要領域を上流に伝播
- 段階2（evaluateTile）: 要求領域のみを処理

**新しいデータ構造**
- `TileStrategy`: 分割戦略（None / Scanline / Tile64 / Custom）
- `RenderContext`: 出力全体情報 + タイル設定
- `RenderRequest`: 部分矩形要求
- `AffinePreparedData` / `FilterPreparedData`: 事前計算データ

**将来の拡張基盤**
- 組込み環境向けタイル分割処理の基盤を整備
- メモリ使用量を制限しながら大きな画像を処理可能に

---

## 2026-01-05

### 状態保存/復元機能

**LocalStorage自動保存**
- ノード追加・削除、接続変更、パラメータ変更時に自動保存
- ページリロード時に前回の状態を自動復元
- 画像ライブラリ（画像データ含む）も保存対象

**URLパラメータ対応**
- 「URLコピー」ボタンで現在の状態をURLにエンコード
- URLを共有することでノードグラフ構成を共有可能
- 同一ブラウザではLocalStorageから画像データを補完

**リセット機能**
- 「リセット」ボタンで保存された状態をクリア
- 初期状態（テストパターン画像）に戻る

### アーキテクチャ改善

**フィルタレジストリパターンの導入**
- JS側: `FILTER_DEFINITIONS`オブジェクトでフィルタ定義を一元管理
  - 新規フィルタ追加時は定義オブジェクトに追加するだけでOK
  - セレクトオプション、UI、デフォルト値が自動生成
- C++側: `FilterRegistry`クラスでフィルタを一元管理
  - if-elseチェーンを削減し、ファクトリパターンに移行
  - 複数パラメータ対応（`filterParams`配列）

**対応フィルタ**
- グレースケール、明るさ、ぼかし、アルファ

### 開発者向け機能

**テストパターン画像の自動生成**
- アプリ起動時に3種類のテストパターン画像を自動生成
  - Checker: チェッカーパターン（青白格子、中央に赤い点）
  - Target: 同心円ターゲット（カラフルな同心円）
  - Grid: グリッド＋十字線（対角線付き）
- アフィン変換や合成のデバッグに便利な点対称パターン

### パフォーマンス最適化

**mergeImages関数の高速化**
- `getPixelPtr`呼び出しを内側ループから外側ループに移動（O(W×H) → O(H)）
- アルファ値による早期終了/スキップ最適化
- 条件付き加算パターンで分岐を統合

**詳細パフォーマンス計測機能**
- WASM内部の処理時間を工程別に計測（Filter/Affine/Composite/Convert/Output）
- コンソールに詳細ログを出力

### UI/UX改善

**左サイドバーメニュー**
- 画像ライブラリと出力設定を統合
- トグルボタンで開閉（ESCキー、オーバーレイクリック対応）
- レスポンシブデザイン（PC/モバイル対応）

**レイアウト改善**
- ノードグラフとプレビュー間にリサイズ可能なスプリッター追加
- プレビュー倍率スライダー追加（1x〜5x）
- スクロール位置の自動中央調整
- ヘッダーのコンパクト化

### 簡素化

- 合成ノードからアフィンパラメータを削除（アフィン変換は専用ノードで）

---

## 2026-01-04

### アーキテクチャ改善

- WebAssemblyバインディングを整理し、NodeGraphEvaluator専用アーキテクチャに移行
- 未使用コード約410行を削除

### バグ修正

- 奇数幅画像での斜め歪みバグを修正

---

## 2026-01-03

### 内部リファクタリング

- 拡張可能ピクセルフォーマットシステムの実装
- ViewPort統一画像型の導入
- フィルタ処理の数学的正確性を改善（Straight alpha形式で処理）
- モジュラーファイル構造への分離

---

## 2026-01-02

### ノードグラフエディタへの移行

**新機能**
- ノードグラフエディタの実装（5種類のノード: 画像、アフィン変換、合成、フィルタ、出力）
- 画像ライブラリ機能
- C++ NodeGraphEvaluator（トポロジカルソート、メモ化）
- ドラッグ&ドロップによるノード配置・接続

**UI/UX改善**
- 動的ノード高さ調整
- リアルタイム接続線更新
- コンテキストメニュー（右クリック）

**ドキュメント整備**
- README.md、QUICKSTART.md、各種ドキュメントの作成・更新

---

*詳細な変更履歴については Git コミット履歴を参照してください。*
