<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Image Transform Preview</title>

    <!-- ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¶å¾¡ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <script>
        // CSSã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°ä»˜ãã§èª­ã¿è¾¼ã¿
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'style.css?t=' + Date.now();
        document.head.appendChild(link);
    </script>
</head>
<body>
    <!-- å·¦è¢–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-content">
            <!-- ç”»åƒãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
            <div class="sidebar-section">
                <div class="sidebar-section-header">
                    <h3>ğŸ“¸ ç”»åƒãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h3>
                </div>
                <button id="sidebar-add-image-btn" class="primary-btn sidebar-add-btn">ğŸ“ ç”»åƒã‚’è¿½åŠ </button>
                <div id="sidebar-images-library" class="sidebar-images-library"></div>
            </div>

            <!-- å‡ºåŠ›è¨­å®š -->
            <div class="sidebar-section sidebar-section-bottom">
                <div class="sidebar-section-header">
                    <h3>âš™ï¸ å‡ºåŠ›è¨­å®š</h3>
                </div>
                <div class="sidebar-settings">
                    <div class="sidebar-setting-group">
                        <span class="sidebar-setting-label">åŸç‚¹</span>
                        <div class="sidebar-setting-row">
                            <div class="sidebar-setting-fields">
                                <div class="sidebar-setting-field">
                                    <label>X</label>
                                    <input type="number" id="sidebar-origin-x" value="400" min="0">
                                </div>
                                <div class="sidebar-setting-field">
                                    <label>Y</label>
                                    <input type="number" id="sidebar-origin-y" value="300" min="0">
                                </div>
                            </div>
                            <div class="origin-grid" id="sidebar-origin-grid">
                                <button class="origin-point" data-x="0" data-y="0" title="å·¦ä¸Š"></button>
                                <button class="origin-point" data-x="0.5" data-y="0" title="ä¸Šä¸­å¤®"></button>
                                <button class="origin-point" data-x="1" data-y="0" title="å³ä¸Š"></button>
                                <button class="origin-point" data-x="0" data-y="0.5" title="å·¦ä¸­å¤®"></button>
                                <button class="origin-point selected" data-x="0.5" data-y="0.5" title="ä¸­å¤®"></button>
                                <button class="origin-point" data-x="1" data-y="0.5" title="å³ä¸­å¤®"></button>
                                <button class="origin-point" data-x="0" data-y="1" title="å·¦ä¸‹"></button>
                                <button class="origin-point" data-x="0.5" data-y="1" title="ä¸‹ä¸­å¤®"></button>
                                <button class="origin-point" data-x="1" data-y="1" title="å³ä¸‹"></button>
                            </div>
                        </div>
                    </div>
                    <div class="sidebar-setting-group">
                        <span class="sidebar-setting-label">ã‚µã‚¤ã‚º</span>
                        <div class="sidebar-setting-row">
                            <div class="sidebar-setting-fields">
                                <div class="sidebar-setting-field">
                                    <label>å¹…</label>
                                    <input type="number" id="sidebar-canvas-width" value="800" min="100" max="2000">
                                </div>
                                <div class="sidebar-setting-field">
                                    <label>é«˜ã•</label>
                                    <input type="number" id="sidebar-canvas-height" value="600" min="100" max="2000">
                                </div>
                            </div>
                            <button id="sidebar-apply-settings" class="primary-btn sidebar-apply-btn">é©ç”¨</button>
                        </div>
                    </div>
                    <div class="sidebar-setting-group">
                        <span class="sidebar-setting-label">è¡¨ç¤ºå€ç‡</span>
                        <div class="sidebar-setting-row">
                            <input type="range" id="sidebar-preview-scale" min="1" max="5" step="0.5" value="1" class="sidebar-scale-slider">
                            <span id="sidebar-preview-scale-value" class="sidebar-scale-value">1x</span>
                        </div>
                    </div>
                    <div class="sidebar-setting-group">
                        <span class="sidebar-setting-label">ã‚¿ã‚¤ãƒ«åˆ†å‰²</span>
                        <div class="sidebar-setting-row">
                            <select id="sidebar-tile-preset" class="sidebar-select">
                                <option value="none">ãªã—ï¼ˆä¸€æ‹¬å‡¦ç†ï¼‰</option>
                                <option value="scanline">ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆ1è¡Œãšã¤ï¼‰</option>
                                <option value="16">16Ã—16</option>
                                <option value="32">32Ã—32</option>
                                <option value="64">64Ã—64</option>
                                <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                            </select>
                        </div>
                        <div class="sidebar-setting-row sidebar-tile-custom" id="sidebar-tile-custom" style="display: none;">
                            <div class="sidebar-setting-fields">
                                <div class="sidebar-setting-field">
                                    <label>å¹…</label>
                                    <input type="number" id="sidebar-tile-width" value="16" min="1" max="512">
                                </div>
                                <div class="sidebar-setting-field">
                                    <label>é«˜ã•</label>
                                    <input type="number" id="sidebar-tile-height" value="16" min="1" max="512">
                                </div>
                            </div>
                        </div>
                        <div class="sidebar-setting-row">
                            <label class="sidebar-checkbox-label sidebar-checkbox-small">
                                <input type="checkbox" id="sidebar-debug-checkerboard">
                                <span>ğŸ› äº¤äº’ã‚¹ã‚­ãƒƒãƒ—</span>
                            </label>
                        </div>
                    </div>
                    <div class="sidebar-setting-group">
                        <span class="sidebar-setting-label">çŠ¶æ…‹ç®¡ç†</span>
                        <div class="sidebar-setting-row sidebar-state-buttons">
                            <button id="copy-state-url-btn" class="secondary-btn" title="ç¾åœ¨ã®çŠ¶æ…‹ã‚’URLã¨ã—ã¦ã‚³ãƒ”ãƒ¼">ğŸ”— URLã‚³ãƒ”ãƒ¼</button>
                            <button id="reset-state-btn" class="secondary-btn danger" title="ä¿å­˜ã•ã‚ŒãŸçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒªã‚»ãƒƒãƒˆ">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰ -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
    <button id="sidebar-toggle" class="sidebar-toggle" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
        <span class="sidebar-toggle-icon">â˜°</span>
    </button>

    <div class="container">
        <header>
            <h1>ğŸ–¼ï¸ Image Transform Preview</h1>
            <p>è¤‡æ•°ç”»åƒã®ã‚¢ãƒ•ã‚£ãƒ³å¤‰æ›ãƒ»åˆæˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</p>
            <div id="version-info" class="version-info"></div>
        </header>

        <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒ¼ãƒ‰ã‚°ãƒ©ãƒ• -->
        <div class="node-graph-section">
            <div class="node-graph-header">
                <h2>ğŸ”— ãƒãƒ¼ãƒ‰ã‚°ãƒ©ãƒ•</h2>
                <div class="node-graph-controls">
                    <div class="node-add-dropdown" id="node-add-dropdown">
                        <button class="node-add-btn" id="node-add-btn">+ ãƒãƒ¼ãƒ‰è¿½åŠ </button>
                        <div class="node-add-menu" id="node-add-menu">
                            <!-- app.jsã®populateNodeAddMenu()ã§å‹•çš„ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="node-graph-canvas-container">
                <svg id="node-graph-canvas" width="1600" height="1200" viewBox="0 0 1600 1200">
                    <!-- ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰ï¼ˆç”»åƒã€ãƒ•ã‚£ãƒ«ã‚¿ã€åˆæˆã€å‡ºåŠ›ï¼‰ãŒã“ã“ã«æç”»ã•ã‚Œã‚‹ -->
                </svg>
                <div class="node-graph-help">
                    ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ãƒãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ï¼†ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹• | ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´
                </div>
            </div>
        </div>

        <!-- ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ãƒãƒ¼ -->
        <div id="splitter" class="splitter">
            <div class="splitter-handle"></div>
        </div>

        <div class="main-content">
            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
            <div class="preview-section">
                <div class="canvas-container">
                    <canvas id="preview-canvas"></canvas>
                </div>
                <div class="canvas-download">
                    <button id="download-btn" class="primary-btn">ğŸ“¥ ç”»åƒã‚’ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
        <input type="file" id="image-input" accept="image/*" style="display:none;" multiple>
    </div>

    <!-- ç”»åƒã‚¢ã‚¤ãƒ†ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ -->
    <template id="image-item-template">
        <div class="image-item">
            <div class="image-thumbnail">
                <img src="" alt="thumbnail">
            </div>
            <div class="image-info">
                <span class="image-name">Image</span>
                <div class="image-actions">
                    <button class="add-image-node-btn" title="ãƒãƒ¼ãƒ‰è¿½åŠ ">+ ãƒãƒ¼ãƒ‰</button>
                    <button class="delete-image-btn" title="å‰Šé™¤">Ã—</button>
                </div>
            </div>
        </div>
    </template>

    <!-- ãƒãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="node-context-menu" class="context-menu" style="display: none;">
        <div class="context-menu-item" id="detail-node-menu">âš™ï¸ è©³ç´°</div>
        <div class="context-menu-item" id="add-input-menu" style="display: none;">â• å…¥åŠ›ã‚’è¿½åŠ </div>
        <div class="context-menu-item" id="delete-node-menu">ğŸ—‘ï¸ ãƒãƒ¼ãƒ‰ã‚’å‰Šé™¤</div>
    </div>

    <!-- ãƒãƒ¼ãƒ‰è©³ç´°ãƒ‘ãƒãƒ« -->
    <div id="node-detail-panel" class="node-detail-panel" style="display: none;">
        <div class="node-detail-header">
            <span class="node-detail-title">ãƒãƒ¼ãƒ‰è©³ç´°</span>
            <button class="node-detail-close">Ã—</button>
        </div>
        <div class="node-detail-content"></div>
    </div>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>WebAssemblyèª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
    <div id="debug-status-bar" class="debug-status-bar">
        <span class="debug-status-label">â±ï¸ Perf:</span>
        <span id="debug-perf-total" class="debug-status-item">--</span>
        <span class="debug-status-sep">|</span>
        <span id="debug-perf-details" class="debug-status-details">--</span>
    </div>

    <!-- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°ä»˜ãã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ -->
    <script>
        // version.jsã‚’åŒæœŸçš„ã«èª­ã¿è¾¼ã‚€
        const versionScript = document.createElement('script');
        versionScript.src = 'version.js?t=' + Date.now();
        document.head.appendChild(versionScript);

        versionScript.onload = function() {
            // ãƒ“ãƒ«ãƒ‰æƒ…å ±ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ï¼ˆgitCommit or buildDateï¼‰
            const version = (typeof BUILD_INFO !== 'undefined')
                ? BUILD_INFO.gitCommit
                : Date.now();

            console.log('Loading scripts with cache buster:', version);

            // WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿
            const wasmScript = document.createElement('script');
            wasmScript.src = 'image_transform.js?v=' + version;
            document.head.appendChild(wasmScript);

            // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’èª­ã¿è¾¼ã¿ï¼ˆWASMã®å¾Œã«ï¼‰
            wasmScript.onload = function() {
                const appScript = document.createElement('script');
                appScript.src = 'app.js?v=' + version;
                document.head.appendChild(appScript);
            };
        };
    </script>
</body>
</html>
