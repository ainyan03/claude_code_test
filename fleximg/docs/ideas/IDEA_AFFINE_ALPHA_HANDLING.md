# アフィン変換時の透明非対応フォーマット問題

## 概要

透明（アルファ）を表現できないピクセルフォーマット（RGB565, RGB888, RGB332）を
アフィン変換すると、画像範囲外が不透明黒として下流に伝わる問題。

## 問題の詳細

### 現状の動作

1. AffineNode が出力バッファをゼロ初期化
2. DDA が有効範囲のみにピクセルを書き込み
3. 範囲外はゼロ値のまま残る
4. 非アルファフォーマットではゼロ = 不透明黒
5. CompositeNode で RGBA16 変換時に不透明黒として扱われる

### 影響

- 回転した画像の角が黒く塗りつぶされる
- 複数画像の合成で背景が見えなくなる
- タイル分割時のみ、AABB外タイルが透明扱いになる（部分的に回避）

---

## 対策案

以下の4案について、それぞれ別ファイルで詳細を記載。

| 案 | ファイル | 概要 |
|----|---------|------|
| A | IDEA_AFFINE_ALPHA_A_CONVERT_TO_RGBA.md | アフィン前にRGBA8に変換 |
| B | IDEA_AFFINE_ALPHA_B_VALID_REGION.md | 出力に有効範囲情報を付加 |
| C | IDEA_AFFINE_ALPHA_C_AABB_CROP.md | アフィン出力をAABB範囲に限定 |
| D | IDEA_AFFINE_ALPHA_D_ALPHA_MASK.md | アルファマスク併用 |

---

## 判断基準

- **メモリ効率**: 組み込み環境での使用を考慮
- **処理速度**: 変換コストと合成コスト
- **API互換性**: 既存コードへの影響
- **実装複雑度**: 保守性

---

## 関連情報

- タイル分割時の挙動: AABB外タイルは `RenderResult` が空で返るため、
  CompositeNode でスキップされ透明扱いになる
- `hasAlpha` フラグ: `PixelFormatDescriptor` に存在し、フォーマット判定に使用可能

---

## 進捗（v2.30.0）

**スキャンライン必須仕様**により、SourceNode のアフィン処理が最適化され、
案B/Cに近いアプローチが部分的に実現された：

- SourceNode の `pullProcessWithAffine()` が有効ピクセル範囲のみのバッファを返却
- `transform::calcValidRange()` で1行単位の有効範囲を事前計算
- 範囲外の0データを下流に送らないため、合成時の問題を軽減

**残る課題**:
- AffineNode が Renderer 下流で使用される場合は依然として AABB サイズのバッファを返す
- 非アルファフォーマットでの根本解決には追加対策が必要
