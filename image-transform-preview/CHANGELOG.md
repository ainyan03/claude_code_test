# Changelog

このプロジェクトの主要な変更を記録します。

---

## 2026-01-06

### 2パス評価システム（タイル分割対応）

**画像切れ問題の修正**
- キャンバスサイズ < 入力画像サイズ + オフセット の場合に発生していた画像切れを修正
- `applyTransform()` / `mergeImages()` に出力サイズパラメータを追加
- アフィン変換の出力サイズを入力画像サイズに基づいて動的決定

**3段階評価アーキテクチャ**
- 段階0（prepare）: 逆行列計算、フィルタカーネル準備などの事前計算
- 段階1（propagateRequests）: タイルごとの必要領域を上流に伝播
- 段階2（evaluateTile）: 要求領域のみを処理

**新しいデータ構造**
- `TileStrategy`: 分割戦略（None / Scanline / Tile64 / Custom）
- `RenderContext`: 出力全体情報 + タイル設定
- `RenderRequest`: 部分矩形要求
- `AffinePreparedData` / `FilterPreparedData`: 事前計算データ

**将来の拡張基盤**
- 組込み環境向けタイル分割処理の基盤を整備
- メモリ使用量を制限しながら大きな画像を処理可能に

---

## 2026-01-05

### 状態保存/復元機能

**LocalStorage自動保存**
- ノード追加・削除、接続変更、パラメータ変更時に自動保存
- ページリロード時に前回の状態を自動復元
- 画像ライブラリ（画像データ含む）も保存対象

**URLパラメータ対応**
- 「URLコピー」ボタンで現在の状態をURLにエンコード
- URLを共有することでノードグラフ構成を共有可能
- 同一ブラウザではLocalStorageから画像データを補完

**リセット機能**
- 「リセット」ボタンで保存された状態をクリア
- 初期状態（テストパターン画像）に戻る

### アーキテクチャ改善

**フィルタレジストリパターンの導入**
- JS側: `FILTER_DEFINITIONS`オブジェクトでフィルタ定義を一元管理
  - 新規フィルタ追加時は定義オブジェクトに追加するだけでOK
  - セレクトオプション、UI、デフォルト値が自動生成
- C++側: `FilterRegistry`クラスでフィルタを一元管理
  - if-elseチェーンを削減し、ファクトリパターンに移行
  - 複数パラメータ対応（`filterParams`配列）

**対応フィルタ**
- グレースケール、明るさ、ぼかし、アルファ

### 開発者向け機能

**テストパターン画像の自動生成**
- アプリ起動時に3種類のテストパターン画像を自動生成
  - Checker: チェッカーパターン（青白格子、中央に赤い点）
  - Target: 同心円ターゲット（カラフルな同心円）
  - Grid: グリッド＋十字線（対角線付き）
- アフィン変換や合成のデバッグに便利な点対称パターン

### パフォーマンス最適化

**mergeImages関数の高速化**
- `getPixelPtr`呼び出しを内側ループから外側ループに移動（O(W×H) → O(H)）
- アルファ値による早期終了/スキップ最適化
- 条件付き加算パターンで分岐を統合

**詳細パフォーマンス計測機能**
- WASM内部の処理時間を工程別に計測（Filter/Affine/Composite/Convert/Output）
- コンソールに詳細ログを出力

### UI/UX改善

**左サイドバーメニュー**
- 画像ライブラリと出力設定を統合
- トグルボタンで開閉（ESCキー、オーバーレイクリック対応）
- レスポンシブデザイン（PC/モバイル対応）

**レイアウト改善**
- ノードグラフとプレビュー間にリサイズ可能なスプリッター追加
- プレビュー倍率スライダー追加（1x〜5x）
- スクロール位置の自動中央調整
- ヘッダーのコンパクト化

### 簡素化

- 合成ノードからアフィンパラメータを削除（アフィン変換は専用ノードで）

---

## 2026-01-04

### アーキテクチャ改善

- WebAssemblyバインディングを整理し、NodeGraphEvaluator専用アーキテクチャに移行
- 未使用コード約410行を削除

### バグ修正

- 奇数幅画像での斜め歪みバグを修正

---

## 2026-01-03

### 内部リファクタリング

- 拡張可能ピクセルフォーマットシステムの実装
- ViewPort統一画像型の導入
- フィルタ処理の数学的正確性を改善（Straight alpha形式で処理）
- モジュラーファイル構造への分離

---

## 2026-01-02

### ノードグラフエディタへの移行

**新機能**
- ノードグラフエディタの実装（5種類のノード: 画像、アフィン変換、合成、フィルタ、出力）
- 画像ライブラリ機能
- C++ NodeGraphEvaluator（トポロジカルソート、メモ化）
- ドラッグ&ドロップによるノード配置・接続

**UI/UX改善**
- 動的ノード高さ調整
- リアルタイム接続線更新
- コンテキストメニュー（右クリック）

**ドキュメント整備**
- README.md、QUICKSTART.md、各種ドキュメントの作成・更新

---

*詳細な変更履歴については Git コミット履歴を参照してください。*
