# 🖼️ Image Transform Preview

ノードベースのグラフエディタで画像処理パイプラインを視覚的に構築できるWebアプリケーションです。C++で実装された画像処理コアをWebAssemblyにコンパイルし、ブラウザ上で動作します。

## 🚀 ライブデモ

**GitHub Pagesで公開中！ビルド不要で即座に試せます：**

👉 **[https://ainyan03.github.io/claude_code_test/](https://ainyan03.github.io/claude_code_test/)**

PC・スマートフォン両方から直接アクセス可能です。C++で実装されたWebAssembly版が動作します。

## ✨ 特徴

- **ノードグラフエディタ**: ドラッグ&ドロップで画像処理パイプラインを視覚的に構築
- **C++コア**: 画像変換処理はC++で実装され、組込み環境への移植が容易
- **WebAssembly**: ブラウザ上でネイティブ速度で動作
- **レスポンシブUI**: PC・スマートフォン両対応
- **リアルタイムプレビュー**: ノードパラメータ変更が即座に反映
- **直感的な操作**: ノード接続とスライダーで簡単にパラメータ調整

## 🎯 機能

### ノードグラフエディタ
- ✅ **画像ライブラリ**: 複数画像の読み込み・管理（ドラッグ&ドロップ対応）
- ✅ **ノードタイプ**:
  - 画像ノード: ライブラリから画像を選択
  - アフィン変換ノード: 平行移動、回転、スケール調整
  - 合成ノード: 複数画像のアルファブレンディング
  - フィルタノード: 明るさ・コントラスト調整
  - 出力ノード: 最終結果のプレビュー
- ✅ **ノード操作**:
  - ドラッグ&ドロップでノードを配置
  - ノード間をワイヤーで接続
  - コンテキストメニューでノード追加・削除
  - パラメータ/行列表示モード切り替え
- ✅ **画像処理**:
  - アフィン変換（平行移動、回転、スケール）
  - 透過度調整（0〜100%）
  - 画像合成（アルファブレンディング）
  - 明るさ・コントラスト調整
- ✅ 合成画像のダウンロード（PNG形式）

### UI機能
- ✅ ノードグラフエディタ（ビジュアルプログラミング）
- ✅ リアルタイムプレビュー
- ✅ カスタマイズ可能なキャンバスサイズ
- ✅ レスポンシブデザイン（モバイル対応）
- ✅ タッチ操作対応

## 📋 必要要件

### 開発環境
- **Emscripten SDK**: C++をWebAssemblyにコンパイルするために必要
- **C++11以上対応コンパイラ**
- **Webサーバー**: ローカルでテストする場合（Python、Node.jsなど）

### 実行環境
- **モダンなWebブラウザ**
  - Chrome/Edge 57+
  - Firefox 52+
  - Safari 11+
  - モバイルブラウザ（iOS Safari、Android Chrome）

## 🔧 セットアップ

### 1. Emscriptenのインストール

```bash
# Emscripten SDKをクローン
git clone https://github.com/emscripten-core/emsdk.git
cd emsdk

# 最新版をインストール
./emsdk install latest
./emsdk activate latest

# 環境変数を設定
source ./emsdk_env.sh
```

### 2. プロジェクトのビルド

```bash
cd image-transform-preview

# ビルドスクリプトを実行
./build.sh
```

ビルドが成功すると、`web/`ディレクトリに以下のファイルが生成されます：
- `image_transform.js`
- `image_transform.wasm`

### 3. アプリケーションの起動

#### Python 3を使用
```bash
cd web
python3 -m http.server 8000
```

#### Node.jsを使用
```bash
cd web
npx http-server -p 8000
```

ブラウザで `http://localhost:8000` を開いてください。

## 📱 使い方

### 基本操作

1. **画像を追加**
   - 画像ライブラリの「+ 画像追加」ボタンをクリック
   - 画像ファイルを選択（複数選択可）
   - ドラッグ&ドロップでも追加可能

2. **ノードの追加**
   - グラフエリアを右クリックしてコンテキストメニューを表示
   - 追加したいノードタイプを選択:
     - 画像ノード: ライブラリの画像を選択
     - アフィン変換ノード: 画像に変換を適用
     - 合成ノード: 複数画像を合成
     - フィルタノード: 明るさ・コントラスト調整
     - 出力ノード: 最終結果を表示
   - ノードは自動的にマウス位置に配置されます

3. **ノードの接続**
   - 出力ポート（右側の青い点）をクリック
   - 入力ポート（左側の青い点）までドラッグ
   - ワイヤーで接続が作成されます
   - 接続を削除するには、ワイヤーを右クリック

4. **パラメータ調整**
   - 各ノードのスライダーを操作してパラメータを調整
   - アフィン変換ノード: X位置、Y位置、回転、スケールX/Y、透過度
   - フィルタノード: 明るさ、コントラスト
   - 「パラメータ/行列」ボタンで表示モードを切り替え可能

5. **ノードの移動・削除**
   - ノードをドラッグして位置を変更
   - ノードを右クリックして「削除」を選択

6. **合成画像の保存**
   - 「📥 合成画像をダウンロード」ボタンをクリック
   - PNG形式でダウンロード

### スマートフォンでの利用

1. PCでアプリケーションを起動
2. スマートフォンのブラウザでPCのIPアドレスにアクセス
   - 例: `http://192.168.1.100:8000`
3. タッチ操作でノードの追加・接続・パラメータ調整が可能
4. ロングタップでコンテキストメニューを表示

## 🏗️ プロジェクト構造

```
image-transform-preview/
├── src/                       # C++ソースコード（モジュラー設計）
│   ├── image_types.h          # 基本型定義
│   ├── filters.h/cpp          # フィルタクラス群
│   ├── image_processor.h/cpp  # コア画像処理エンジン
│   ├── node_graph.h/cpp       # ノードグラフ評価エンジン
│   └── bindings.cpp           # Emscriptenバインディング
├── web/
│   ├── index.html             # メインHTML
│   ├── style.css              # スタイルシート
│   ├── app.js                 # JavaScript制御
│   ├── image_transform.js     # 生成されたWebAssemblyラッパー
│   └── image_transform.wasm   # 生成されたWebAssemblyバイナリ
├── build.sh                   # ビルドスクリプト
└── README.md                  # このファイル
```

## 🔬 技術詳細

### C++コア（組込み環境への移植可能）

モジュラー設計のC++コアは、標準C++のみを使用しており、以下の機能を提供します：

- **基本型**（`image_types.h`）:
  - Image構造体: 8bit RGBAピクセルデータ（API境界用）
  - AffineParams/AffineMatrix構造体: アフィン変換パラメータ
- **フィルタシステム**（`filters.h/cpp`）:
  - ImageFilter基底クラス（ViewPortベース）
  - BrightnessFilter, GrayscaleFilter, BoxBlurFilter, AlphaFilter
  - Straight alpha形式で処理（数学的に正確）
- **画像処理エンジン**（`image_processor.h/cpp`）:
  - フィルタ適用、アフィン変換、画像合成
  - 8bit ↔ 16bit変換機能
- **ノードグラフエンジン**（`node_graph.h/cpp`）:
  - ノードグラフの評価エンジン
  - トポロジカルソートによる依存関係解決
  - ノードタイプ別の画像処理実行
  - メモ化による重複計算の回避
- **画像処理機能**:
  - アフィン変換（バイリニア補間）
  - アルファブレンディング
  - 画像合成
  - 明るさ・コントラスト調整

### アフィン変換の実装

逆変換方式を採用し、出力ピクセルごとに入力画像の対応位置を計算：

1. キャンバス中心を基準点とする
2. 平行移動の逆変換
3. 回転の逆変換
4. スケールの逆変換
5. バイリニア補間でピクセル値を取得

### WebAssemblyバインディング

Emscriptenの`embind`を使用してC++クラスをJavaScriptから呼び出し可能にしています。

## 🚀 組込み環境への移植

モジュラー設計のC++コアは、以下の特徴により組込み環境への移植が容易です：

- **依存関係なし**: 標準C++のみを使用（OpenCVなど不要）
- **モジュラー設計**: 必要なモジュールだけを選択して使用可能
- **シンプルなAPI**: `NodeGraphEvaluator`クラスでノードグラフを評価
- **メモリ管理**: `std::vector`を使用（カスタムアロケータに変更可能）
- **拡張性**: 新しいフィルタやノードタイプを簡単に追加可能

### 移植手順

1. 必要なファイルをコピー:
   - 最小構成: `image_types.h`, `image_processor.h/cpp`
   - フィルタ使用: `filters.h/cpp`も追加
   - ノードグラフ使用: `node_graph.h/cpp`も追加
2. 必要に応じて`std::vector`をカスタムアロケータに置き換え
3. プロジェクトに組み込んでビルド

## 🛠️ 開発

### ビルドオプションのカスタマイズ

`build.sh`内のEmscriptenコンパイルオプション：

- `-O3`: 最適化レベル（速度優先）
- `-s ALLOW_MEMORY_GROWTH=1`: 動的メモリ確保
- `-s TOTAL_MEMORY=256MB`: 初期メモリサイズ
- `-s MAXIMUM_MEMORY=512MB`: 最大メモリサイズ

### デバッグビルド

```bash
emcc src/filters.cpp src/image_processor.cpp src/node_graph.cpp src/bindings.cpp \
    -o web/image_transform.js \
    -std=c++17 \
    -O0 -g \
    -s ASSERTIONS=1 \
    # ... その他のオプション
```

## 📄 ライセンス

このプロジェクトは自由に使用・改変できます。

## 🤝 貢献

バグ報告や機能提案は歓迎します。

## 📞 サポート

問題が発生した場合：

1. ブラウザのコンソールでエラーメッセージを確認
2. Emscriptenが正しくインストールされているか確認
3. ブラウザがWebAssemblyに対応しているか確認

## 🎉 楽しんでください！

画像変換を試して、面白い合成画像を作成してみてください！
